{
  "version": 3,
  "file": "nodeHttpExecutor.js",
  "sourceRoot": "",
  "sources": [
    "../../src/util/nodeHttpExecutor.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import { Socket } from \"net\"\nimport { IncomingMessage, ClientRequest, Agent } from \"http\"\nimport * as https from \"https\"\nimport { createWriteStream, ensureDir, readFile } from \"fs-extra-p\"\nimport BluebirdPromise from \"bluebird-lst-c\"\nimport * as path from \"path\"\nimport { homedir } from \"os\"\nimport { parse as parseIni } from \"ini\"\nimport { HttpExecutor, DownloadOptions, HttpError, DigestTransform } from \"./httpExecutor\"\nimport { Url } from \"url\"\nimport { RequestOptions } from \"https\"\nimport { safeLoad } from \"js-yaml\"\nimport { parse as parseUrl } from \"url\"\nimport { debug } from \"./util\"\n\nexport class NodeHttpExecutor implements HttpExecutor {\n  private readonly maxRedirects = 10\n\n  private httpsAgent: Promise<Agent> | null = null\n\n  request<T>(url: Url, token: string | null = null, data: {[name: string]: any; } | null = null, method: string = \"GET\"): Promise<T> {\n    const options: any = Object.assign({\n      method: method,\n      headers: {\n        \"User-Agent\": \"electron-builder\"\n      }\n    }, url)\n\n    if (url.hostname!!.includes(\"github\") && !url.path!.endsWith(\".yml\")) {\n      options.headers.Accept = \"application/vnd.github.v3+json\"\n    }\n\n    const encodedData = data == null ? null : new Buffer(JSON.stringify(data))\n    if (encodedData != null) {\n      options.method = \"post\"\n      options.headers[\"Content-Type\"] = \"application/json\"\n      options.headers[\"Content-Length\"] = encodedData.length\n    }\n    return this.doApiRequest<T>(options, token, it => it.end(encodedData))\n  }\n\n  download(url: string, destination: string, options?: DownloadOptions | null): Promise<string> {\n    return <BluebirdPromise<string>>(this.httpsAgent || (this.httpsAgent = createAgent()))\n      .then(it => new BluebirdPromise( (resolve, reject) => {\n        this.doDownload(url, destination, 0, options || {}, it, (error: Error) => {\n          if (error == null) {\n            resolve(destination)\n          }\n          else {\n            reject(error)\n          }\n        })\n      }))\n  }\n\n  private addTimeOutHandler(request: ClientRequest, callback: (error: Error) => void) {\n    request.on(\"socket\", function (socket: Socket) {\n      socket.setTimeout(60 * 1000, () => {\n        callback(new Error(\"Request timed out\"))\n        request.abort()\n      })\n    })\n  }\n\n  private doDownload(url: string, destination: string, redirectCount: number, options: DownloadOptions, agent: Agent, callback: (error: Error | null) => void) {\n    const ensureDirPromise = options.skipDirCreation ? BluebirdPromise.resolve() : ensureDir(path.dirname(destination))\n\n    const parsedUrl = parseUrl(url)\n    // user-agent must be specified, otherwise some host can return 401 unauthorised\n    const request = https.request({\n      hostname: parsedUrl.hostname,\n      path: parsedUrl.path,\n      headers: {\n        \"User-Agent\": \"electron-builder\"\n      },\n      agent: agent,\n    }, (response: IncomingMessage) => {\n      if (response.statusCode >= 400) {\n        callback(new Error(`Cannot download \"${url}\", status ${response.statusCode}: ${response.statusMessage}`))\n        return\n      }\n\n      const redirectUrl = response.headers.location\n      if (redirectUrl != null) {\n        if (redirectCount < this.maxRedirects) {\n          this.doDownload(redirectUrl, destination, redirectCount++, options, agent, callback)\n        }\n        else {\n          callback(new Error(\"Too many redirects (> \" + this.maxRedirects + \")\"))\n        }\n        return\n      }\n\n      const sha2Header = response.headers[\"X-Checksum-Sha2\"]\n      if (sha2Header != null && options.sha2 != null) {\n        // todo why bintray doesn't send this header always\n        if (sha2Header == null) {\n          throw new Error(\"checksum is required, but server response doesn't contain X-Checksum-Sha2 header\")\n        }\n        else if (sha2Header !== options.sha2) {\n          throw new Error(`checksum mismatch: expected ${options.sha2} but got ${sha2Header} (X-Checksum-Sha2 header)`)\n        }\n      }\n\n      ensureDirPromise\n        .then(() => {\n          const fileOut = createWriteStream(destination)\n          if (options.sha2 == null) {\n            response.pipe(fileOut)\n          }\n          else {\n            response\n              .pipe(new DigestTransform(options.sha2))\n              .pipe(fileOut)\n          }\n\n          fileOut.on(\"finish\", () => (<any>fileOut.close)(callback))\n        })\n        .catch(callback)\n\n      let ended = false\n      response.on(\"end\", () => {\n        ended = true\n      })\n\n      response.on(\"close\", () => {\n        if (!ended) {\n          callback(new Error(\"Request aborted\"))\n        }\n      })\n    })\n    this.addTimeOutHandler(request, callback)\n    request.on(\"error\", callback)\n    request.end()\n  }\n\n\n  doApiRequest<T>(options: RequestOptions, token: string | null, requestProcessor: (request: ClientRequest, reject: (error: Error) => void) => void, redirectCount: number = 0): Promise<T> {\n    debug(`HTTPS request: ${JSON.stringify(options, null, 2)}`)\n\n    if (token != null) {\n      (<any>options.headers).authorization = token.startsWith(\"Basic\") ? token : `token ${token}`\n    }\n\n    return new BluebirdPromise<T>((resolve, reject, onCancel) => {\n      const request = https.request(options, (response: IncomingMessage) => {\n        try {\n          if (response.statusCode === 404) {\n            // error is clear, we don't need to read detailed error description\n            reject(new HttpError(response, `method: ${options.method} url: https://${options.hostname}${options.path}\n\nPlease double check that your authentication token is correct. Due to security reasons actual status maybe not reported, but 404.\n`))\n          }\n          else if (response.statusCode === 204) {\n            // on DELETE request\n            resolve()\n            return\n          }\n\n          const redirectUrl = response.headers.location\n          if (redirectUrl != null) {\n            if (redirectCount > 10) {\n              reject(new Error(\"Too many redirects (> 10)\"))\n              return\n            }\n\n            if (options.path!.endsWith(\"/latest\")) {\n              resolve(<any>{location: redirectUrl})\n            }\n            else {\n              this.doApiRequest(Object.assign({}, options, parseUrl(redirectUrl)), token, requestProcessor)\n                .then(<any>resolve)\n                .catch(reject)\n            }\n            return\n          }\n\n          let data = \"\"\n          response.setEncoding(\"utf8\")\n          response.on(\"data\", (chunk: string) => {\n            data += chunk\n          })\n\n          response.on(\"end\", () => {\n            try {\n              const contentType = response.headers[\"content-type\"]\n              const isJson = contentType != null && contentType.includes(\"json\")\n              if (response.statusCode >= 400) {\n                if (isJson) {\n                  reject(new HttpError(response, JSON.parse(data)))\n                }\n                else {\n                  reject(new HttpError(response))\n                }\n              }\n              else {\n                resolve(data.length === 0 ? null : (isJson || !options.path!.includes(\".yml\")) ? JSON.parse(data) : safeLoad(data))\n              }\n            }\n            catch (e) {\n              reject(e)\n            }\n          })\n        }\n        catch (e) {\n          reject(e)\n        }\n      })\n      this.addTimeOutHandler(request, reject)\n      request.on(\"error\", reject)\n      requestProcessor(request, reject)\n      onCancel!(() => request.abort())\n    })\n  }\n}\n\n// only https proxy\nasync function proxyFromNpm() {\n  let data = \"\"\n  try {\n    data = await readFile(path.join(homedir(), \".npmrc\"), \"utf-8\")\n  }\n  catch (ignored) {\n    return null\n  }\n\n  if (!data) {\n    return null\n  }\n\n  try {\n    const config = parseIni(data)\n    return config[\"https-proxy\"] || config.proxy\n  }\n  catch (e) {\n    // used in nsis auto-updater, do not use .util.warn here\n    console.warn(e)\n    return null\n  }\n}\n\n// only https url\nasync function createAgent() {\n  let proxyString: string =\n    process.env.npm_config_https_proxy ||\n    process.env.HTTPS_PROXY || process.env.https_proxy ||\n    process.env.npm_config_proxy\n\n  if (!proxyString) {\n    proxyString = await proxyFromNpm()\n    if (!proxyString) {\n      return null\n    }\n  }\n\n  const proxy = parseUrl(proxyString)\n\n  const proxyProtocol = proxy.protocol === \"https:\" ? \"Https\" : \"Http\"\n  return require(\"tunnel-agent\")[`httpsOver${proxyProtocol}`]({\n    proxy: {\n      port: proxy.port || (proxyProtocol === \"Https\" ? 443 : 80),\n      host: proxy.hostname,\n      proxyAuth: proxy.auth\n    }\n  })\n}\n\n"
  ]
}
